<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>数学と理科の関連性についての調査</title>
  <style>
    /* ページ全体の基本フォント */
    body {
      font-family: 'Arial', 'Helvetica', sans-serif;
      font-size: 1em;
    }
    /* 質問ラベルのフォントサイズ */
    .question-label { font-size: 1em; }
    /* テーブルの見た目設定 */
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1em;
    }
    th, td {
      border: 1px solid black;
      padding: 8px;
      text-align: center;
    }
    /* 入力不可セルの背景色 */
    .disabled {
      background-color: #ddd;
      pointer-events: none;
    }
    /* ボタン共通スタイル */
    button {
      margin-top: 20px;
      padding: 10px;
      cursor: pointer;
    }
    /* 入力エラー時の強調 */
    select.error, input.error {
      border: 2px solid red;
      background-color: #fdd;
    }
    /* 確認画面と出力画面の共通設定 */
    #preview, #outputData {
      display: none;
      border: 1px solid #999;
      padding: 10px;
      margin-top: 20px;
    }
    /* 確認画面の背景色 */
    #preview { background-color: #eef; }
    /* 出力データ画面の背景色 */
    #outputData { background-color: #efe; }
    /* テキストエリアのサイズ */
    textarea { width: 100%; height: 100px; font-size: 1em; }
  </style>
  <script>
    // 出力用の「固定順」ラベルリスト（元の並び替え順）
    const originalLabels = [
      "位置",
      "速度",
      "加速度",
      "等速直線運動",
      "等加速度運動",
      "鉛直投射",
      "斜方投射",
      "y=ax+b",
      "y=ax^2+bx+c",
      "1次関数",
      "2次関数"
    ];
    
    // ラベルをシャッフルして入力画面に使うための配列
    let shuffledLabels = [];

    document.addEventListener("DOMContentLoaded", function() {
      // シャッフル順を作成
      shuffledLabels = [...originalLabels].sort(() => Math.random() - 0.5);
      
      // 入力テーブルを動的生成
      let html = "<table><tr><th></th>";
      shuffledLabels.forEach(l => html += `<th>${l}</th>`);
      html += "</tr>";
      shuffledLabels.forEach((l, i) => {
        html += `<tr><th>${l}</th>`;
        shuffledLabels.forEach((_, j) => {
          if (j < i) {
            // 下三角部には選択肢プルダウン
            html += `<td><select required>
                       <option value=""></option>
                       <option value="0">0</option>
                       <option value="1">1</option>
                       <option value="2">2</option>
                       <option value="3">3</option>
                     </select></td>`;
          } else {
            // 上三角部は入力不可
            html += `<td class="disabled">-</td>`;
          }
        });
        html += "</tr>";
      });
      html += "</table>";
      document.getElementById("matrix").innerHTML = html;
    });

    // 入力内容の妥当性チェック（0～3の選択と学籍番号形式）
    function validateInputs() {
      let valid = true;
      document.querySelectorAll("td select").forEach(s => {
        if (!/^[0-3]$/.test(s.value)) {
          s.classList.add("error");
          valid = false;
        } else {
          s.classList.remove("error");
        }
      });
      let id = document.getElementById("studentId");
      if (!/^[A-Za-z0-9]{7}$/.test(id.value.trim())) {
        id.classList.add("error");
        valid = false;
      } else {
        id.classList.remove("error");
      }
      if (!valid) {
        alert("入力にエラーがあります．０～３の選択肢および7桁の英数字の学籍番号を正しく入力してください．");
      }
      return valid;
    }

    // 確認画面を表示（入力時と同じシャッフル順でレビュー）
    function confirmPreview() {
      if (!validateInputs()) return;
      let sid = document.getElementById("studentId").value.trim();

      // 入力値を行列に集約
      let mat = Array(shuffledLabels.length).fill().map(() => Array(shuffledLabels.length).fill("-"));
      document.querySelectorAll("table tr").forEach((tr, i) => {
        if (i === 0) return;  // ヘッダー行はスキップ
        tr.querySelectorAll("td select").forEach((s, j) => {
          mat[j][i - 1] = s.value;
        });
      });

      // プレビュー用テーブルを生成
      let html = `<h3>回答内容の確認</h3>
                  <p><strong>学籍番号：</strong>${sid}</p>
                  <table><tr><th></th>`;
      shuffledLabels.forEach(l => html += `<th>${l}</th>`);
      html += `</tr>`;
      shuffledLabels.forEach((l, i) => {
        html += `<tr><th>${l}</th>`;
        shuffledLabels.forEach((_, j) => {
          html += j < i
            ? `<td><input type="text" value="${mat[j][i]}" disabled class="preview-field"></td>`
            : `<td>-</td>`;
        });
        html += `</tr>`;
      });
      html += `<br><button onclick="outputData()">データを出力</button>
               <button onclick="hidePreview()">修正する</button>`;

      let prev = document.getElementById("preview");
      prev.innerHTML = html;
      prev.style.display = "block";
      document.getElementById("outputData").style.display = "none";
      prev.scrollIntoView({ behavior: "smooth" });
    }

    // 確認画面を閉じて入力画面に戻す
    function hidePreview() {
      document.getElementById("preview").style.display = "none";
      document.getElementById("outputData").style.display = "none";
    }

    // 元の順序に並び替えた上で、下三角部の値を1行ベクトル化して出力
    function outputData() {
      // 入力値を再集約
      let mat = Array(shuffledLabels.length).fill().map(() => Array(shuffledLabels.length).fill("-"));
      document.querySelectorAll("table tr").forEach((tr, i) => {
        if (i === 0) return;
        tr.querySelectorAll("td select").forEach((s, j) => {
          mat[j][i - 1] = s.value;
        });
      });

      // シャッフル順→固定順のマッピング
      let map = originalLabels.map(l => shuffledLabels.indexOf(l));

      // 下三角部を固定順で取り出しベクトルに
      let vec = [];
      originalLabels.forEach((_, r) => {
        for (let c = 0; c < r; c++) {
          let i = map[r], j = map[c];
          let row = Math.max(i, j), col = Math.min(i, j);
          vec.push(mat[col][row]);
        }
      });
      let txt = vec.join(",");

      // 出力画面に表示・コピー可能に
      let out = document.getElementById("outputData");
      out.innerHTML = `<h3>出力データ</h3>
                       <textarea id="finalOutput">${txt}</textarea>
                       <br><button onclick="copyFinal()">ベクトルをコピー</button>`;
      out.style.display = "block";
      out.scrollIntoView({ behavior: "smooth" });
    }

    // コピー機能
    function copyFinal() {
      let ta = document.getElementById("finalOutput");
      ta.select();
      document.execCommand("copy");
      alert("ベクトルをコピーしました．");
    }
  </script>
</head>
<body>
  <h2>数学と理科の関連性についての調査</h2>
  <p>調査にご協力いただきありがとうございます．この調査は，数学と理科の関連性について調べるために行うものです．正しい答えや間違った答えはありませんので，思ったとおりに答えてください．回答はすべてコンピュータにより統計的に処理されますので，個人が特定されることはありません．また，回答が研究目的以外に使用されることはありません．</p>

  <label for="studentId" class="question-label">
    <strong>あなたの学籍番号を入力してください（7桁の英数字）：</strong>
  </label>
  <input type="text" id="studentId" maxlength="7" pattern="[A-Za-z0-9]{7}" required>

  <h3 class="question-label"><strong>以下の単語や数式同士にはどのくらい関係があると思いますか？</strong></h3>
  <p class="question-label">関係があると思う度合いを「関係がない：0～関係がある：3」の4段階で表に入力してください．</p>

  <div id="matrix"></div>
  <button onclick="confirmPreview()">回答を確認する</button>

  <div id="preview"></div>
  <div id="outputData"></div>
</body>
</html>
