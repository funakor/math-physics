<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>数学と理科の関連性調査</title>
  <style>
    /* ゴシック体 */
    body {
      font-family: 'Arial', 'Helvetica', sans-serif;
      /* 説明文等の基本フォントサイズ */
      font-size: 1em;
    }
    /* 質問文のフォントサイズを説明文と統一 */
    .question-label {
      font-size: 1em;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid black;
      padding: 8px;
      text-align: center;
    }
    .disabled {
      background-color: #ddd;
      pointer-events: none;
    }
    button {
      margin-top: 20px;
      padding: 10px;
      cursor: pointer;
    }
    /* 署名エリア：右揃え */
    .signature {
      text-align: right;
      margin-top: 40px;
      line-height: 1.5;
    }
    /* エラー時のスタイル */
    input.error {
      border: 2px solid red;
      background-color: #fdd;
    }
  </style>
  <script>
    // 固定の概念ラベル順（CSV出力時の並び順用）
    const originalLabels = [
      "フックの法則",
      "ばねの伸び=ばね定数×力の大きさ",
      "オームの法則",
      "電圧=電流×電気抵抗",
      "等速直線運動",
      "移動距離=速さ×時間",
      "比例",
      "y=ax",
      "変化の割合",
      "傾き",
      "表",
      "グラフ"
    ];

    let shuffledLabels = []; // ランダム順を保持（グローバル）

    document.addEventListener("DOMContentLoaded", function () {
      // ラベルをランダムに並び替え（行と列は同じ順）
      shuffledLabels = [...originalLabels].sort(() => Math.random() - 0.5);

      let tableHTML = "<table><tr><th></th>";
      shuffledLabels.forEach(label => {
        tableHTML += `<th>${label}</th>`;
      });
      tableHTML += "</tr>";

      // 各行生成：下三角（対角線未満）の部分だけ入力可能
      shuffledLabels.forEach((label, rowIndex) => {
        tableHTML += `<tr><th>${label}</th>`;
        shuffledLabels.forEach((_, colIndex) => {
          if (colIndex < rowIndex) {
            tableHTML += `<td><input type="number" min="0" max="3" step="1" required></td>`;
          } else {
            tableHTML += `<td class="disabled">-</td>`;
          }
        });
        tableHTML += "</tr>";
      });
      tableHTML += "</table>";
      document.getElementById("matrix").innerHTML = tableHTML;
    });

    // 入力セルの検証：すべて０～３の整数が入力されているかを確認し，エラー時は色付きスタイルを付与
    function validateInputs() {
      let valid = true;
      const inputs = document.querySelectorAll("td input");

      inputs.forEach(input => {
        const value = input.value.trim();
        // 正しい値（０～３の整数）かをチェック
        if (!/^[0-3]$/.test(value)) {
          input.classList.add("error");
          valid = false;
        } else {
          input.classList.remove("error");
        }
      });

      // 生徒番号欄のチェックも実施
      const studentIdInput = document.getElementById("studentId");
      const studentValue = studentIdInput.value.trim();
      if (!/^\d{4}$/.test(studentValue)) {
        studentIdInput.classList.add("error");
        valid = false;
      } else {
        studentIdInput.classList.remove("error");
      }
      if (!valid) {
        alert("入力にエラーがあります．０～３の整数および４桁の生徒番号を正しく入力してください．");
      }
      return valid;
    }

    function downloadCSV() {
      if (!validateInputs()) return;

      // 生徒番号取得（エラーチェック済み）
      const studentId = document.getElementById("studentId").value.trim();

      // ヘッダー行は先頭セルを空欄とし，固定順の概念ラベルのみを出力
      let csvContent = "," + originalLabels.join(",") + "\n";

      // 入力データを記録するための行列（ランダム順で下三角部分に入力値が格納）
      let dataMatrix = Array(shuffledLabels.length).fill(null).map(() =>
        Array(shuffledLabels.length).fill("-")
      );

      // テーブルから入力値を読み出し（下三角部分）
      const rows = document.querySelectorAll("table tr");
      // rows[0] はヘッダーなので，i＝1から開始
      for (let i = 1; i < rows.length; i++) {
        const inputs = rows[i].querySelectorAll("td input");
        // 各行の入力セルは，もともとその行 (i－1) の下三角部分に対応
        inputs.forEach((cell, j) => {
          // 入力されたセルは，ランダム順のテーブル内での位置 (j, i－1)
          dataMatrix[j][i - 1] = cell.value.trim();
        });
      }

      // 元の順序（originalLabels）に合わせるためのマッピング：
      // 各ラベルが shuffledLabels 内でのどの位置にあるかを記録
      let orderMapping = originalLabels.map(label => shuffledLabels.indexOf(label));

      // CSV の各データ行を作成（ヘッダー行以外）
      // 各行は先頭セルにその行の概念ラベル，それ以降は転置して保存した入力値
      for (let origRow = 0; origRow < originalLabels.length; origRow++) {
        let rowArr = [];
        // 先頭セル：行の概念ラベル
        rowArr.push(originalLabels[origRow]);

        for (let origCol = 0; origCol < originalLabels.length; origCol++) {
          if (origCol >= origRow) {
            // 対角および上三角領域は "-" とする
            rowArr.push("-");
          } else {
            // ラベル origRow と origCol の shuffled 内での位置を取得
            let posRow = orderMapping[origRow];
            let posCol = orderMapping[origCol];
            // 入力値は常に下三角に記録されるので，dataMatrix[min][max]から取得
            let rowIndex = Math.max(posRow, posCol);
            let colIndex = Math.min(posRow, posCol);
            rowArr.push(dataMatrix[colIndex][rowIndex]);
          }
        }
        csvContent += rowArr.join(",") + "\n";
      }

      // ファイル名：math_physics_survey_生徒番号.csv とする
      let fileName = "math_physics_survey_" + studentId + ".csv";

      // CSV ダウンロード処理
      let blob = new Blob([csvContent], { type: "text/csv" });
      let a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  </script>
</head>
<body>
  <h2>数学と理科の関連性調査</h2>
  <p>
    調査にご協力いただきありがとうございます．この調査は，数学と理科の関連性について調べるために行うものです．正しい答えや間違った答えはありませんので，思ったとおりに答えてください．回答はすべてコンピュータにより統計的に処理されますので，個人が特定されることはありません．また，回答が研究目的以外に使用されることはありません．
  </p>

  <label for="studentId" class="question-label"><strong>あなたの生徒番号を入力してください（4桁）：</strong></label>
  <input type="text" id="studentId" maxlength="4" pattern="\d{4}" required>

  <h3 class="question-label"><strong>以下の単語や数式同士にはどのくらい関係があると思いますか？</strong></h3>
  <p class="question-label">関係があると思う度合いを「関係がない：0～関係がある：3」の4段階で表に入力してください．</p>

  <div id="matrix"></div>

  <button onclick="downloadCSV()">CSVとしてダウンロード</button>
  
  <!-- 署名エリア（右揃え・3行） -->
  <div class="signature">
    <p>カリタス女子中学高等学校</p>
    <p>舩越 亮太</p>
    <p>funakoshir@caritas.ed.jp</p>
  </div>
</body>
</html>

